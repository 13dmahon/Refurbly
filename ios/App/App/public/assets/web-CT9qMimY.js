import{W as F}from"./index-C5kOux9O.js";import{getFirestore as o,addDoc as p,collection as l,setDoc as w,doc as u,getDoc as f,updateDoc as Q,deleteDoc as g,writeBatch as D,getDocs as y,getCountFromServer as P,clearIndexedDbPersistence as M,enableNetwork as W,disableNetwork as v,connectFirestoreEmulator as A,onSnapshot as h,query as m,collectionGroup as C,and as N,or as L,where as B,endBefore as k,endAt as G,startAfter as x,startAt as E,limitToLast as I,limit as S,orderBy as R}from"./index.esm-CRjskAss.js";import"./index.esm2017-Bi2ccvWJ.js";class J extends F{constructor(){super(...arguments),this.unsubscribesMap=new Map}async addDocument(e){const t=o(),{reference:a,data:r}=e,s=await p(l(t,a),r);return{reference:{id:s.id,path:s.path}}}async setDocument(e){const t=o(),{reference:a,data:r,merge:s}=e;await w(u(t,a),r,{merge:s})}async getDocument(e){const t=o(),{reference:a}=e,r=await f(u(t,a)),s=r.data();return{snapshot:{id:r.id,path:r.ref.path,data:s===void 0?null:s,metadata:{hasPendingWrites:r.metadata.hasPendingWrites,fromCache:r.metadata.fromCache}}}}async updateDocument(e){const t=o(),{reference:a,data:r}=e;await Q(u(t,a),r)}async deleteDocument(e){const t=o(),{reference:a}=e;await g(u(t,a))}async writeBatch(e){const t=o(),{operations:a}=e,r=D(t);for(const s of a){const{type:n,reference:c,data:i,options:d}=s,b=u(t,c);switch(n){case"set":r.set(b,i,d??{});break;case"update":r.update(b,i??{});break;case"delete":r.delete(b);break}}await r.commit()}async getCollection(e){const t=await this.buildCollectionQuery(e,"collection");return{snapshots:(await y(t)).docs.map(r=>({id:r.id,path:r.ref.path,data:r.data(),metadata:{hasPendingWrites:r.metadata.hasPendingWrites,fromCache:r.metadata.fromCache}}))}}async getCollectionGroup(e){const t=await this.buildCollectionQuery(e,"collectionGroup");return{snapshots:(await y(t)).docs.map(r=>({id:r.id,path:r.ref.path,data:r.data(),metadata:{hasPendingWrites:r.metadata.hasPendingWrites,fromCache:r.metadata.fromCache}}))}}async getCountFromServer(e){const t=o(),{reference:a}=e,r=l(t,a);return{count:(await P(r)).data().count}}async clearPersistence(){const e=o();await M(e)}async enableNetwork(){const e=o();await W(e)}async disableNetwork(){const e=o();await v(e)}async useEmulator(e){const t=o(),a=e.port||8080;A(t,e.host,a)}async addDocumentSnapshotListener(e,t){const a=o(),r=h(u(a,e.reference),{includeMetadataChanges:e.includeMetadataChanges,source:e.source},n=>{const c=n.data(),i={snapshot:{id:n.id,path:n.ref.path,data:c===void 0?null:c,metadata:{hasPendingWrites:n.metadata.hasPendingWrites,fromCache:n.metadata.fromCache}}};t(i,void 0)},n=>t(null,n)),s=Date.now().toString();return this.unsubscribesMap.set(s,r),s}async addCollectionSnapshotListener(e,t){const a=await this.buildCollectionQuery(e,"collection"),r=h(a,{includeMetadataChanges:e.includeMetadataChanges,source:e.source},n=>{const c={snapshots:n.docs.map(i=>({id:i.id,path:i.ref.path,data:i.data(),metadata:{hasPendingWrites:i.metadata.hasPendingWrites,fromCache:i.metadata.fromCache}}))};t(c,void 0)},n=>t(null,n)),s=Date.now().toString();return this.unsubscribesMap.set(s,r),s}async addCollectionGroupSnapshotListener(e,t){const a=await this.buildCollectionQuery(e,"collectionGroup"),r=h(a,{includeMetadataChanges:e.includeMetadataChanges,source:e.source},n=>{const c={snapshots:n.docs.map(i=>({id:i.id,path:i.ref.path,data:i.data(),metadata:{hasPendingWrites:i.metadata.hasPendingWrites,fromCache:i.metadata.fromCache}}))};t(c,void 0)},n=>t(null,n)),s=Date.now().toString();return this.unsubscribesMap.set(s,r),s}async removeSnapshotListener(e){const t=this.unsubscribesMap.get(e.callbackId);t&&(t(),this.unsubscribesMap.delete(e.callbackId))}async removeAllListeners(){this.unsubscribesMap.forEach(e=>e()),this.unsubscribesMap.clear(),await super.removeAllListeners()}async buildCollectionQuery(e,t){const a=o();let r;if(e.compositeFilter){const s=this.buildFirebaseQueryCompositeFilterConstraint(e.compositeFilter),n=await this.buildFirebaseQueryNonFilterConstraints(e.queryConstraints||[]);r=m(t==="collection"?l(a,e.reference):C(a,e.reference),s,...n)}else{const s=await this.buildFirebaseQueryConstraints(e.queryConstraints||[]);r=m(t==="collection"?l(a,e.reference):C(a,e.reference),...s)}return r}buildFirebaseQueryCompositeFilterConstraint(e){const t=this.buildFirebaseQueryFilterConstraints(e.queryConstraints);return e.type==="and"?N(...t):L(...t)}buildFirebaseQueryFilterConstraints(e){const t=[];for(const a of e){const r=this.buildFirebaseQueryFilterConstraint(a);t.push(r)}return t}buildFirebaseQueryFilterConstraint(e){return e.type==="where"?this.buildFirebaseQueryFieldFilterConstraint(e):this.buildFirebaseQueryCompositeFilterConstraint(e)}buildFirebaseQueryFieldFilterConstraint(e){return B(e.fieldPath,e.opStr,e.value)}async buildFirebaseQueryNonFilterConstraints(e){const t=[];for(const a of e){const r=await this.buildFirebaseQueryNonFilterConstraint(a);t.push(r)}return t}async buildFirebaseQueryNonFilterConstraint(e){switch(e.type){case"orderBy":return R(e.fieldPath,e.directionStr);case"limit":return S(e.limit);case"limitToLast":return I(e.limit);case"startAt":case"startAfter":case"endAt":case"endBefore":{const t=o(),a=await f(u(t,e.reference));switch(e.type){case"startAt":return E(a);case"startAfter":return x(a);case"endAt":return G(a);case"endBefore":return k(a)}}}}async buildFirebaseQueryConstraints(e){const t=[];for(const a of e){const r=await this.buildFirebaseQueryConstraint(a);t.push(r)}return t}async buildFirebaseQueryConstraint(e){return e.type==="where"?this.buildFirebaseQueryFieldFilterConstraint(e):await this.buildFirebaseQueryNonFilterConstraint(e)}}export{J as FirebaseFirestoreWeb};
