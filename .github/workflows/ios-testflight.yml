name: iOS TestFlight (Capacitor + Fastlane + Match)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "ios/**"
      - "src/**"
      - "public/**"
      - "package.json"
      - "package-lock.json"
      - "capacitor.config.*"
      - "vite.config.*"
      - "fastlane/**"
      - ".github/workflows/ios-testflight.yml"

concurrency:
  group: ios-testflight-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-upload:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show commit and vite config used by this run
        run: |
          echo "=== COMMIT ==="
          git log -1 --oneline
          echo "=== vite.config.js ==="
          sed -n '1,200p' vite.config.js || true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps & build web app
        run: |
          npm install
          npm run build
          echo "=== Built files ==="
          ls -la dist/ || true
          echo "=== index.html (before patch) ==="
          sed -n '1,200p' dist/index.html || true

      # Force absolute asset URLs + remove crossorigin + neutralize window.onerror alert
      - name: Make asset URLs absolute + drop crossorigin + disable onerror alert
        run: |
          # BSD sed first; fallback to GNU sed if needed
          sed -i '' 's|src="./assets/|src="/assets/|g'  dist/index.html || sed -i 's|src="./assets/|src="/assets/|g'  dist/index.html
          sed -i '' 's|href="./assets/|href="/assets/|g' dist/index.html || sed -i 's|href="./assets/|href="/assets/|g' dist/index.html
          sed -i '' -E 's/[[:space:]]crossorigin(="anonymous")?//g' dist/index.html || sed -i -E 's/[[:space:]]crossorigin(="anonymous")?//g' dist/index.html
          # Replace any alert() in the onerror handler with console logging so it never blocks the UI
          sed -i '' -E 's/alert\([^)]*\);/console.log("Global error:", msg, url, line, col, error);/g' dist/index.html || \
          sed -i -E 's/alert\([^)]*\);/console.log("Global error:", msg, url, line, col, error);/g' dist/index.html

          echo "=== index.html (after patch) ==="
          sed -n '1,200p' dist/index.html || true
          echo "=== grep for crossorigin (should be empty) ==="
          ! grep -n "crossorigin" dist/index.html || true

      - name: Sync iOS platform (Capacitor runs pod install)
        run: npx cap sync ios

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install Fastlane
        run: gem install fastlane --no-document

      - name: Build and upload to TestFlight
        env:
          ASC_API_KEY_ID:    ${{ secrets.ASC_API_KEY_ID }}
          ASC_API_ISSUER_ID: ${{ secrets.ASC_API_ISSUER_ID }}
          ASC_API_KEY_P8:    ${{ secrets.ASC_API_KEY_P8 }}
          APPLEID_USERNAME:  ${{ secrets.APPLEID_USERNAME }}
          APP_IDENTIFIER:    ${{ secrets.APP_IDENTIFIER }}
          DEV_TEAM:          ${{ secrets.DEV_TEAM }}
          MATCH_REPO:        ${{ secrets.MATCH_REPO }}
          MATCH_PASSWORD:    ${{ secrets.MATCH_PASSWORD }}
          IOS_WORKSPACE:     ios/App/App.xcworkspace
          IOS_SCHEME:        App
        run: fastlane ios beta
