name: iOS TestFlight (Capacitor + Fastlane + Match)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "ios/**"
      - "src/**"
      - "public/**"
      - "package.json"
      - "package-lock.json"
      - "capacitor.config.*"
      - "vite.config.*"
      - "fastlane/**"
      - ".github/workflows/ios-testflight.yml"

jobs:
  build-upload:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps & build web app
        run: |
          npm install
          npm run build

      - name: Sync iOS platform (Capacitor runs pod install)
        run: |
          npx cap sync ios

      # Optional: if you ever need to debug schemes, uncomment:
      # - name: Debug Xcode schemes
      #   run: xcodebuild -list -workspace ios/App/App.xcworkspace

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install Fastlane
        run: gem install fastlane --no-document

      - name: Build and upload to TestFlight
        env:
          # App Store Connect API key (your secret names)
          ASC_API_KEY_ID:    ${{ secrets.ASC_API_KEY_ID }}
          ASC_API_ISSUER_ID: ${{ secrets.ASC_API_ISSUER_ID }}
          ASC_API_KEY_P8:    ${{ secrets.ASC_API_KEY_P8 }}

          # Apple / app identifiers
          APPLEID_USERNAME:  ${{ secrets.APPLEID_USERNAME }}
          APP_IDENTIFIER:    ${{ secrets.APP_IDENTIFIER }}
          DEV_TEAM:          ${{ secrets.DEV_TEAM }}

          # fastlane match repo + encryption password
          MATCH_REPO:        ${{ secrets.MATCH_REPO }}
          MATCH_PASSWORD:    ${{ secrets.MATCH_PASSWORD }}

          # Capacitor iOS workspace/scheme (defaults)
          IOS_WORKSPACE:     ios/App/App.xcworkspace
          IOS_SCHEME:        App
        run: fastlane ios beta
